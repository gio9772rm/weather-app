name: Ingest Ecowitt

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # ogni 15 minuti (adatta come vuoi)

jobs:
  ingest:
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      ECOWITT_APP_KEY: ${{ secrets.ECOWITT_APP_KEY }}
      ECOWITT_API_KEY: ${{ secrets.ECOWITT_API_KEY }}
      ECOWITT_MAC: ${{ secrets.ECOWITT_MAC }}
      LOG_LEVEL: DEBUG
      BACKFILL_HOURS: 0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Show repo files (debug)
        run: |
          pwd
          ls -la

      - name: Install deps (requirements-ingest or requirements_ingest)
        shell: bash
        run: |
          python -m pip install --upgrade pip
          REQ=""
          if [ -f requirements-ingest.txt ]; then
            REQ="requirements-ingest.txt"
          elif [ -f requirements_ingest.txt ]; then
            REQ="requirements_ingest.txt"
          elif [ -f requirements.txt ]; then
            REQ="requirements.txt"
          fi

          if [ -z "$REQ" ]; then
            echo "Nessun requirements trovato. Esci."
            exit 1
          fi

          echo "Uso $REQ"
          pip install -r "$REQ"

      - name: Run ingest (Ecowitt Cloud)
        run: |
          python weather_ingest_ecowitt_cloud.py
