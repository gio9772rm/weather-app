name: Ingest Ecowitt

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  ingest:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      ECOWITT_APP_KEY: ${{ secrets.ECOWITT_APP_KEY }}
      ECOWITT_API_KEY: ${{ secrets.ECOWITT_API_KEY }}
      ECOWITT_MAC: ${{ secrets.ECOWITT_MAC }}
      LOG_LEVEL: DEBUG
      BACKFILL_HOURS: 0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check env presence (masked)
        run: |
          python - << 'PY'
          import os
          keys = ["DATABASE_URL","ECOWITT_APP_KEY","ECOWITT_API_KEY","ECOWITT_MAC"]
          for k in keys:
            v = os.getenv(k)
            print(f"{k}: {'set' if v else 'MISSING'}", end='')
            if v: print(f" (len={len(v)})")
            else: print()
          PY

      - name: Install deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          REQ=""
          if [ -f requirements-ingest.txt ]; then
            REQ="requirements-ingest.txt"
          elif [ -f requirements_ingest.txt ]; then
            REQ="requirements_ingest.txt"
          elif [ -f requirements.txt ]; then
            REQ="requirements.txt"
          fi
          if [ -z "$REQ" ]; then
            echo "Nessun requirements trovato. Esco."
            exit 1
          fi
          echo "Uso $REQ"
          pip install -r "$REQ"

      - name: Run ingest (Ecowitt Cloud)
        run: |
          python weather_ingest_ecowitt_cloud.py
